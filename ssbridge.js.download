(function (root, factory) {
    if (typeof define === 'function' && define.amd) {
        define([], factory);
    } else if (typeof exports === 'object') {
        module.exports = factory();
    } else {
        root.ssbridge = factory();
    }
}(this, function () {

    /* 
      - Storing messages in sessionStorage.
      - Clients subscribe to the changes and
        they get notified if a new message arrives.
    */

    var api = {};

    api.isSSAvailable = (function () {
        var mod = '_';
        try {
            sessionStorage.setItem(mod, mod);
            sessionStorage.removeItem(mod);
            return true;
        } catch (e) {
            return false;
        }
    })();

    window.addEventListener('storage', function (e) {
        if (e.storageArea == sessionStorage) {
            var namespace = e.key;
            if (listeners[namespace] != undefined) {
                listeners[namespace].forEach(function (listener) {
                    data = e.newValue;
                    if (data != null) {
                        var parsed = JSON.parse(data);
                        if (parsed) data = parsed;
                        listener(data);
                    }
                });
                try{
                    ss.removeItem(namespace);
                } catch (e) {

                }
            }
        }
    });

    window.parent.addEventListener('storage', function (e) {
        var namespace = e.key;
        if (listeners[namespace] != undefined) {
            listeners[namespace].forEach(function (listener) {
                data = e.newValue;
                if (data != null) {
                    var parsed = JSON.parse(data);
                    if (parsed) data = parsed;
                    listener(data);
                }
            });
            try{
                ss.removeItem(namespace);
            } catch (e) {

            }
        }
    });

    if (api.isSSAvailable) {

        var removeInterval = 1000
           , ss = sessionStorage
        var listeners = {};

        api.send = function (namespace, data) {
            var raw = '';
            if (typeof data === 'function') { data = data(); }
            if (typeof data === 'object') {
                raw = JSON.stringify(data);
            } else {
                raw = data;
            }
            ss.setItem(namespace, raw);
        };


        api.subscribe = function (namespace, cb) {
            if (!listeners[namespace]) {
                listeners[namespace] = [];
            }
            listeners[namespace].push(cb);

            //window.addEventListener('storage', function (e) {
            //    //e.target.removeEventListener(e.type, arguments.callee);
            //    if (e.key == namespace) {
            //        if (e.storageArea == sessionStorage) {
            //            data = e.newValue;
            //            var parsed = JSON.parse(data);
            //            if (parsed) data = parsed;
            //            cb(data);
            //            setTimeout(function () {
            //                if (ss.getItem(namespace) != undefined)
            //                    ss.removeItem(namespace);
            //              }, removeInterval);
            //        }
            //    }
            //});
            
            if (ss.getItem(namespace) != undefined) {
                var data = ss.getItem(namespace);
                var parsed = JSON.parse(data);
                if (parsed) data = parsed;
                cb(data);
                setTimeout(function () {
                    if (ss.getItem(namespace) != undefined)
                        ss.removeItem(namespace);
                }, removeInterval);
            }
        };

    } else {
        api.send = api.subscribe = function () {
            throw new Error('sessionStorage not supported.');
        }
    }

    return api;
}));