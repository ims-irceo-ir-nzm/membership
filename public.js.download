// باشگاه مدیران ایران - JavaScript عمومی

document.addEventListener('DOMContentLoaded', function() {
    
    // تست Bootstrap
    console.log('Bootstrap loaded:', typeof bootstrap !== 'undefined');
    
    // تست dropdown ها
    const dropdownToggles = document.querySelectorAll('.navbar-nav .dropdown-toggle');
    console.log('Dropdown toggles found:', dropdownToggles.length);
    
    dropdownToggles.forEach((toggle, index) => {
        console.log(`Dropdown ${index + 1}:`, toggle.textContent.trim());
    });

    // فعال‌سازی dropdown ها در موبایل
    function initMobileDropdowns() {
        const dropdownToggles = document.querySelectorAll('.navbar-nav .dropdown-toggle');
        
        dropdownToggles.forEach(toggle => {
            // حذف event listener های قبلی
            toggle.removeEventListener('click', handleMobileDropdownClick);
            
            // اضافه کردن event listener جدید
            toggle.addEventListener('click', handleMobileDropdownClick);
        });
    }

    function handleMobileDropdownClick(e) {
        // فقط در موبایل کار کند
        if (window.innerWidth >= 992) {
            return;
        }

        e.preventDefault();
        e.stopPropagation();

        const dropdown = this.nextElementSibling;
        const isOpen = dropdown.classList.contains('show');

        console.log('Mobile dropdown clicked:', this.textContent.trim(), 'isOpen:', isOpen);

        // بستن همه dropdown های دیگر
        document.querySelectorAll('.navbar-nav .dropdown-menu').forEach(menu => {
            menu.classList.remove('show');
        });
        
        // reset aria-expanded برای همه toggle ها
        document.querySelectorAll('.navbar-nav .dropdown-toggle').forEach(toggle => {
            toggle.setAttribute('aria-expanded', 'false');
        });

        // باز/بسته کردن dropdown فعلی
        if (!isOpen) {
            dropdown.classList.add('show');
            this.setAttribute('aria-expanded', 'true');
            console.log('Mobile dropdown opened');
        } else {
            this.setAttribute('aria-expanded', 'false');
            console.log('Mobile dropdown closed');
        }
    }

    // اجرای اولیه
    initMobileDropdowns();

    // اجرای مجدد بعد از تغییر اندازه صفحه
    window.addEventListener('resize', function() {
        // فقط در موبایل دوباره initialize کن
        if (window.innerWidth < 992) {
            initMobileDropdowns();
        }
    });

    // تست اضافی برای اطمینان
    setTimeout(() => {
        console.log('=== Mobile Dropdown Test ===');
        const dropdowns = document.querySelectorAll('.navbar-nav .dropdown-menu');
        console.log('Dropdown menus found:', dropdowns.length);
        
        dropdowns.forEach((dropdown, index) => {
            console.log(`Dropdown ${index + 1}:`, dropdown);
            console.log(`  - Parent:`, dropdown.parentElement);
            console.log(`  - Toggle:`, dropdown.previousElementSibling);
        });
    }, 1000);

    
    // فعال‌سازی tooltip ها
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // انیمیشن برای کارت‌ها
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    // مشاهده کارت‌ها برای انیمیشن
    document.querySelectorAll('.stats-card, .event-card, .manager-card').forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(card);
    });

    // اسکرول نرم برای لینک‌های داخلی
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // فعال‌سازی منوی موبایل
    const navbarToggler = document.querySelector('.navbar-toggler');
    const navbarCollapse = document.querySelector('.navbar-collapse');
    
    if (navbarToggler && navbarCollapse) {
        // بستن منو بعد از کلیک روی لینک
        document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 992) {
                    navbarCollapse.classList.remove('show');
                }
            });
        });
    }


    // لودینگ برای دکمه‌ها
    document.querySelectorAll('.btn-primary-custom').forEach(button => {
        button.addEventListener('click', function() {
            if (!this.classList.contains('loading')) {
                const originalText = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>در حال بارگذاری...';
                this.classList.add('loading');
                
                // بعد از 2 ثانیه، متن اصلی رو برگردون
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.classList.remove('loading');
                }, 2000);
            }
        });
    });

    // فرمت کردن اعداد
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // اعمال فرمت اعداد به عناصر با کلاس stats-number
    document.querySelectorAll('.stats-number').forEach(element => {
        const number = parseInt(element.textContent);
        if (!isNaN(number)) {
            element.textContent = formatNumber(number);
        }
    });

    // فعال‌سازی lazy loading برای تصاویر
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    img.classList.remove('lazy');
                    imageObserver.unobserve(img);
                }
            });
        });

        document.querySelectorAll('img[data-src]').forEach(img => {
            imageObserver.observe(img);
        });
    }

    // نمایش پیام‌های فلش
    function showFlashMessage(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // حذف خودکار بعد از 5 ثانیه
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // نمایش پیام‌های فلش از session
    if (typeof flashMessages !== 'undefined') {
        Object.keys(flashMessages).forEach(type => {
            flashMessages[type].forEach(message => {
                showFlashMessage(type, message);
            });
        });
    }

    // فعال‌سازی جستجو در رویدادها
    const searchInput = document.querySelector('#eventSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const eventCards = document.querySelectorAll('.event-card');
            
            eventCards.forEach(card => {
                const title = card.querySelector('.card-title').textContent.toLowerCase();
                const description = card.querySelector('.card-text').textContent.toLowerCase();
                
                if (title.includes(searchTerm) || description.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    }
});
