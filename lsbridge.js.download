(function(root, factory) {
    if(typeof define === 'function' && define.amd) {
        define([], factory);
    } else if(typeof exports === 'object') {
        module.exports = factory();
    } else {
        root.lsbridge = factory();
    }
}(this, function() {

    /* 
      - Storing messages in localStorage.
      - Clients subscribe to the changes and
        they get notified if a new message arrives.
    */

    var api = {};

    api.isLSAvailable = (function() {
        var mod = '_';
        try {
            localStorage.setItem(mod, mod);
            localStorage.removeItem(mod);
            return true;
        } catch(e) {
            return false;
        }
    })();

    window.addEventListener('storage', function (e) {
        if (e.storageArea != sessionStorage) {
            var namespace = e.key;
            if (listeners[namespace] != undefined) {
                listeners[namespace].forEach(function (listener) {
                    data = e.newValue;
                    if (data != null) {
                        var parsed = JSON.parse(data);
                        if (parsed) data = parsed;
                        listener(data);
                    }
                });
                try{
                    ls.removeItem(namespace);
                } catch (e) {

                }
            }
        }
    });
    window.parent.addEventListener('storage', function (e) {
        if (e.storageArea != sessionStorage) {
            var namespace = e.key;
            if (listeners[namespace] != undefined) {
                listeners[namespace].forEach(function (listener) {
                    data = e.newValue;
                    if (data != null) {
                        var parsed = JSON.parse(data);
                        if (parsed) data = parsed;
                        listener(data);
                    }
                });
                try{
                    ls.removeItem(namespace);
                } catch (e) {

                }
            }
        }
    });

    if(api.isLSAvailable) {

        var removeInterval = 1000
          , ls = localStorage
        var listeners = {};

        api.send = function (namespace, data) {
            var raw = '';
            if(typeof data === 'function') { data = data(); }
            if(typeof data === 'object') {
                raw = JSON.stringify(data);
            } else {
                raw = data;
            }
            ls.setItem(namespace, raw);
        };

    
        api.subscribe = function (namespace, cb) {
            if (!listeners[namespace]) {
                listeners[namespace] = [];
            }
            listeners[namespace].push(cb);

            //window.addEventListener('storage', function (e) {
            //    if (e.key == namespace) {
            //        if (e.storageArea != sessionStorage) {  
            //            if (ls.getItem(namespace) != undefined) {
            //                data = e.newValue;
            //                var parsed = JSON.parse(data);
            //                if (parsed) data = parsed;
            //                cb(data);
            //                setTimeout(function () {
            //                    if (ls.getItem(namespace) != undefined)
            //                        ls.removeItem(namespace);
            //                }, removeInterval);
            //            }
            //        }
            //    }
            //});

            if (ls.getItem(namespace) != undefined) {
                var data = ls.getItem(namespace);
                var parsed = JSON.parse(data);
                if (parsed) data = parsed;
                cb(data);
                setTimeout(function () {
                    if (ls.getItem(namespace) != undefined)
                        ls.removeItem(namespace);
                }, removeInterval);               
            }
        };

    } else {
        api.send = api.subscribe = function() {
            throw new Error('localStorage not supported.');
        }
    }

    return api;
}));